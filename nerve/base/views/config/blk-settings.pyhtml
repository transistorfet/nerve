
    <%
    typeslist = nerve.query('/modules/get_types', nerve.Device)

    last_label = 0
    def treeview_object(dirname, expand=False):
        global last_label
        last_label += 1

        obj = nerve.get_object(dirname)

        %>
        <li class="directory"><input type="checkbox" id="<%= 'item-' + str(last_label) %>" <%= ' checked' if expand else '' %> />
        <label for="<%= 'item-' + str(last_label) %>"><%= dirname %><button class="object-delete" data-object="<%= dirname %>">x</button></label>
        <%

            %>
            <ul>
                <div id="nerve-notice" style="display: none;"></div>
                <div id="nerve-error" style="display: none;"></div>
            <%

            if hasattr(obj, '__type__'):
                %>
                <li><div class="nerve-form-item">
                    <label>Type</label>
                    <span><%= obj.__type__ %></span>
                </div></li>
                <%
            end

            config_info = obj.get_config_info()
            for setting in config_info:
                if setting['datatype'] in ('int', 'float', 'str', 'bool', 'textarea'):
                    %>
                    <li><div class="nerve-form-item">
                        <label><%= setting['propername'] %></label>
                        <span>
                            <% if setting['datatype'] == 'bool': %>
                            <input type="checkbox" name="<%= setting['name'] %>" value="1" <%= ' checked' if obj.get_setting(setting['name']) else '' %> />
                            <% elif setting['datatype'] == 'textarea': %>
                            <textarea name="<%= setting['name'] %>"><%= obj.get_setting(setting['name']) %></textarea>
                            <% else: %>
                            <input type="text" name="<%= setting['name'] %>" value="<%= obj.get_setting(setting['name']) %>" />
                            <% end %>
                        </span>
                    </div></li>
                    <%
                end
            end

            for setting in config_info:
                if setting['datatype'] in ('list', 'tuple'):
                    output_list_treeview(obj.get_setting(setting['name']), setting['name'])
                elif setting['datatype'] in ('dict',):
                    output_dict_treeview(obj.get_setting(setting['name']), setting['name'])
                end
            end

            if len(config_info) > 0:
                %>
                <button class="object-save" data-object="<%= dirname %>">Save</button>
                <div style="clear: both;"></div>
                <%
            end

            for name in sorted(obj.keys_children()):
                treeview_object(dirname + '/' + name if not dirname.endswith('/') else '/' + name)
            end
            %>
                <button class="add" data-object="<%= dirname %>">Add</button>
                <div style="display: none;">
                    <div id="nerve-notice" style="display: none;"></div>
                    <div id="nerve-error" style="display: none;"></div>
                    <div class="nerve-form-item-row">
                        <input type="text" name="__name__" />
                        <select class="add-select-type">
                            <option value="">(select type)</option>
                            <% for typename in typeslist: %>
                            <option value="<%= typename %>"><%= typename %></option>
                            <% end %>
                        </select>
                    </div>
                    <div id="add-settings"></div>
                    <div>
                        <button class="add-create" data-object="<%= dirname %>">Create</button>
                        <button class="add-cancel">Cancel</button>
                    </div>
                </div>
            <%

            %>
            </ul>
        </li>
        <%
    end

    def output_dict_treeview(obj, objname):
        global last_label
        last_label += 1

        if not obj:
            return
        end

        %>
        <li><input type="checkbox" id="<%= 'item-' + str(last_label) %>" /><label class="nerve-treeview alt-label" for="<%= 'item-' + str(last_label) %>"><%= objname %></label>
        <ul>
        <%

        for name in sorted(obj.keys()):
            if type(obj[name]) in [ int, float, str ]:
                %>
                <li><div class="nerve-form-item">
                    <label><%= name.capitalize() %></label>
                    <span><input type="text" name="<%= name %>" value="<%= obj[name] %>" /></span>
                </div></li>
                <%
            elif type(obj[name]) == dict:
                output_dict_treeview(obj[name], name)
            end
        end

        %>
        </ul></li>
        <%
    end

    def output_list_treeview(objectlist, objname):
        global last_label
        last_label += 1

        %>
        <li><input type="checkbox" id="<%= 'item-' + str(last_label) %>" /><label class="nerve-treeview alt-label" for="<%= 'item-' + str(last_label) %>"><%= objname %></label>
        <ul>
        <%

        for index, obj in enumerate(objectlist):
            if type(obj) in [ int, float, str ]:
                %>
                <li><div class="nerve-form-item">
                    <label><%= name.capitalize() %></label>
                    <span><input type="text" name="<%= index %>" value="<%= obj %>" /></span>
                </div></li>
                <%
            elif type(obj) == dict:
                output_dict_treeview(obj, index)
            end
        end

        %>
        </ul></li>
        <%
    end
    %>

    <h3>Modules</h3>
    <div class="nerve-treeview">
        <% for name in nerve.query('/modules/get_module_list'): %>
        <div class="nerve-form-item">
            <label><%= name %></label>
            <input type="checkbox" name="<%= name %>" <%= ' checked' %> />
        </div>
        <% end %>
        <button class="modules-save">Save</button>
    </div>
    <div style="clear: both;"></div>

    <h3>Devices</h3>
    <div class="nerve-treeview">
        <% treeview_object('/', True) %>
    </div>
    <div style="clear: both;"></div>

    <h3>Events</h3>
    <div class="nerve-treeview">
        <% treeview_object('/events', True) %>
    </div>
    <div style="clear: both;"></div>

    <% typeslist = nerve.query('/modules/get_types', nerve.Server) %>

    <h3>Servers</h3>
    <div class="nerve-treeview">
        <% treeview_object('/servers', True) %>
    </div>
    <div style="clear: both;"></div>

